{% extends "base.html" %}
{% block title %}Runs – {{ device_id }}{% endblock %}
{% block style %}
<style>
.row { display: grid; grid-template-columns: 1fr; gap: 1rem; margin-top: 1rem; }
.card { border: 1px solid #ddd; border-radius: 10px; padding: 1rem; }
/* Make wide tables scroll within the card */
.table-container { max-width: 100%; overflow-x: auto; overflow-y: hidden; }
table { border-collapse: collapse; width: 100%; table-layout: auto; }
th, td { padding: .35rem .5rem; border-bottom: 1px solid #eee; border-right: 1px solid #eee; font-size: .9rem; text-align: left; white-space: nowrap; }
th { background: #fafafa; position: sticky; top: 0; }
.table-wrapper { max-height: 420px; overflow-y: auto; overflow-x: auto; }
code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: .85rem; }
</style>
{% endblock %}
{% block content %}
<nav style="margin-bottom:1rem;">
  <a href="{{ url_for('device_select') }}" class="btn" style="background:var(--gray200);color:var(--black);">← Devices</a>
  <a href="{{ url_for('device_detail', device_id=device_id) }}" class="btn">Device</a>
  <a href="{{ url_for('download_page', device_id=device_id) }}" class="btn" style="background:var(--gray200);color:var(--black);">Download CSVs</a>
</nav>
<h2>Runs for {{ device_id }}</h2>

<div class="row">
  <div class="card">
    <h3>Known Runs</h3>
    <div class="small" id="status">Loading…</div>
    <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th style="width: auto; min-width: 4rem;">run</th>
          <th style="width: auto; min-width: 10rem;">Run start time</th>
          <th style="width: auto; min-width: 5rem;">Duration</th>
          <th style="width: auto; min-width: 5rem;">Baseline</th>          
          <th style="width: auto; min-width: 5rem;">Threshold</th>          
          <th style="width: auto; min-width: 3.5rem;">Leader</th>
          <th style="width: auto; min-width: 5rem;">Reset<br>threshold</th>
          <th class="actions" style="width: auto; min-width: 9rem; text-align: left;">Actions</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    </div>
  </div>
  <div class="card">
    <h3>Notes</h3>
    <ul>
      <li>Runs are announced by the device with a base timestamp.</li>
      <li>If telemetry includes only <code>dt</code> (ms), the bridge computes <code>ts = base_ts + dt</code>.</li>
    </ul>
  </div>
  
</div>
{% endblock %}
{% block scripts %}
<script>
  const deviceId = "{{ device_id }}";
  const tbody = document.getElementById('tbody');
  const status = document.getElementById('status');

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
  }

  function formatDuration(seconds, inferred) {
    if (seconds == null || !isFinite(seconds)) return '';
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = Math.floor(seconds % 60);
    const formatted = `${h}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    return inferred ? `${formatted} (inferred)` : formatted;
  }

  function render(rows) {
    if (!rows || !rows.length) {
      status.textContent = 'No runs found';
      tbody.innerHTML = '';
      return;
    }
    status.textContent = `${rows.length} run(s)`;
    // rows are newest-first (base_ts desc). For each run, end = start of the next newer run.
    tbody.innerHTML = rows.map((r, idx) => {
      let localTs = '';
      try {
        if (r.base_ts) {
          const d = new Date(r.base_ts);
          if (!isNaN(d.getTime())) localTs = d.toLocaleString();
        }
      } catch {}
      const runLabel = (r.run_key ? String(r.run_key) : (r.id != null ? String(r.id) : ''));
      // Parse meta as JSON to extract fields (may be string or object)
      let metaObj = null;
      try {
        if (r.meta && typeof r.meta === 'string') metaObj = JSON.parse(r.meta);
        else if (r.meta && typeof r.meta === 'object') metaObj = r.meta;
      } catch {}
      const baseline = metaObj && metaObj.baseline != null ? String(metaObj.baseline) : '';
      const threshold = metaObj && metaObj.threshold != null ? String(metaObj.threshold) : '';
      const isLeader = metaObj && typeof metaObj.is_leader !== 'undefined' ? (metaObj.is_leader ? 'Y' : 'N') : '';
      const resetThr = metaObj && metaObj.reset_threshold != null ? String(metaObj.reset_threshold) : '';
      const duration = formatDuration(r.duration_s, r.duration_inferred);
      const startIso = r.base_ts || '';
      const endIso = (idx > 0 && rows[idx - 1] && rows[idx - 1].base_ts) ? rows[idx - 1].base_ts : '';
      const href = `/api/export/${encodeURIComponent(deviceId)}.csv` + (startIso ? `?start=${encodeURIComponent(startIso)}${endIso ? `&end=${encodeURIComponent(endIso)}` : ''}` : '');
      const analyzeHref = `/device/${encodeURIComponent(deviceId)}/analyze${r.id != null ? `?run_id=${encodeURIComponent(r.id)}` : ''}`;
      return `<tr>
        <td><code>${runLabel ? 'Run ' + escapeHtml(runLabel) : ''}</code></td>
        <td><code>${escapeHtml(localTs)}</code></td>
        <td><code>${escapeHtml(duration)}</code></td>
        <td><code>${escapeHtml(baseline)}</code></td>
        <td><code>${escapeHtml(threshold)}</code></td>
        <td><code>${escapeHtml(isLeader)}</code></td>
        <td><code>${escapeHtml(resetThr)}</code></td>
        <td class="actions" style="text-align:left; white-space: nowrap;">${startIso ? `<a class="btn" href="${href}">CSV</a>` : ''} <a class="btn" style="background:var(--gray200);color:var(--black);" href="${analyzeHref}">Analyze</a></td>
      </tr>`;
    }).join('');
  }

  async function load() {
    try {
      const res = await fetch(`/api/device/${encodeURIComponent(deviceId)}/runs?_=${Date.now()}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const rows = await res.json();
      render(rows);
    } catch (e) {
      status.textContent = 'Failed to load runs';
    }
  }

  load();
</script>
{% endblock %}
