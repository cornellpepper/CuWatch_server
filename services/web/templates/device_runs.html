{% extends "base.html" %}
{% block title %}Runs – {{ device_id }}{% endblock %}
{% block style %}
<style>
.row { display: grid; grid-template-columns: 1fr; gap: 1rem; margin-top: 1rem; }
.card { border: 1px solid #ddd; border-radius: 10px; padding: 1rem; }
table { border-collapse: collapse; width: 100%; }
th, td { padding: .35rem .5rem; border-bottom: 1px solid #eee; font-size: .9rem; text-align: left; }
th { background: #fafafa; position: sticky; top: 0; }
tbody { display: block; max-height: 420px; overflow: auto; }
thead, tbody tr { display: table; width: 100%; table-layout: fixed; }
code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: .85rem; }
</style>
{% endblock %}
{% block content %}
<nav style="margin-bottom:1rem;">
  <a href="{{ url_for('device_select') }}" class="btn" style="background:var(--gray200);color:var(--black);">← Devices</a>
  <a href="{{ url_for('device_detail', device_id=device_id) }}" class="btn">Device</a>
  <a href="{{ url_for('download_page', device_id=device_id) }}" class="btn" style="background:var(--gray200);color:var(--black);">Download CSVs</a>
</nav>
<h2>Runs for {{ device_id }}</h2>

<div class="row">
  <div class="card">
    <h3>Known Runs</h3>
    <div class="small" id="status">Loading…</div>
    <table>
      <thead>
        <tr>
          <th style="width: 14rem;">base_ts</th>
          <th style="width: 10rem;">run_key</th>
          <th>meta</th>
          <th style="width: 8rem;">CSV</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
  <div class="card">
    <h3>Notes</h3>
    <ul>
      <li>Runs are announced by the device with a base timestamp.</li>
      <li>If telemetry includes only <code>dt</code> (ms), the bridge computes <code>ts = base_ts + dt</code>.</li>
    </ul>
  </div>
  
</div>
{% endblock %}
{% block scripts %}
<script>
  const deviceId = "{{ device_id }}";
  const tbody = document.getElementById('tbody');
  const status = document.getElementById('status');

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
  }

  function render(rows) {
    if (!rows || !rows.length) {
      status.textContent = 'No runs found';
      tbody.innerHTML = '';
      return;
    }
    status.textContent = `${rows.length} run(s)`;
    // rows are newest-first (base_ts desc). For each run, end = start of the next newer run.
    tbody.innerHTML = rows.map((r, idx) => {
      let meta = r.meta;
      if (meta && typeof meta === 'object') meta = JSON.stringify(meta);
      let localTs = '';
      try {
        if (r.base_ts) {
          const d = new Date(r.base_ts);
          if (!isNaN(d.getTime())) localTs = d.toLocaleString();
        }
      } catch {}
      const startIso = r.base_ts || '';
      const endIso = (idx > 0 && rows[idx - 1] && rows[idx - 1].base_ts) ? rows[idx - 1].base_ts : '';
      const href = `/api/export/${encodeURIComponent(deviceId)}.csv` + (startIso ? `?start=${encodeURIComponent(startIso)}${endIso ? `&end=${encodeURIComponent(endIso)}` : ''}` : '');
      return `<tr>
        <td><code>${escapeHtml(localTs)}</code></td>
        <td><code>${escapeHtml(r.run_key || '')}</code></td>
        <td><code>${escapeHtml(meta || '')}</code></td>
        <td>${startIso ? `<a class="btn" href="${href}">Download</a>` : ''}</td>
      </tr>`;
    }).join('');
  }

  async function load() {
    try {
      const res = await fetch(`/api/device/${encodeURIComponent(deviceId)}/runs?_=${Date.now()}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const rows = await res.json();
      render(rows);
    } catch (e) {
      status.textContent = 'Failed to load runs';
    }
  }

  load();
</script>
{% endblock %}
