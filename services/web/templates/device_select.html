{% extends "base.html" %}
{% block title %}Select Device â€“ CuWatch{% endblock %}
{% block style %}
<style>
ul { padding-left: 1.25rem; }
.meta { color: #444; font-size: .9rem; }
a.btn { display: inline-block; margin-top: .5rem; background: #eee; padding: .3rem .6rem; border-radius: 6px; text-decoration: none; }
.top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
.logout { color: #b31b1b; text-decoration: none; }
</style>
{% endblock %}
{% block content %}
<div class="top">
  <h1>Select a Device</h1>
  <a class="logout" href="{{ url_for('logout') }}">Logout</a>
</div>
<div class="small" style="color: #666; margin-bottom: 1rem;">
  Last updated: <span id="last-updated">{{ moment().format('YYYY-MM-DD HH:mm:ss') if moment else 'loading...' }}</span>
</div>
<div id="device-list">
{% if devices|length == 0 %}
  <p>No devices found.</p>
{% else %}
  <ul>
    {% for d in devices %}
      <li style="margin-bottom:.7rem;">
        <a href="{{ url_for('device_detail', device_id=d.id) }}" class="btn" style="background:var(--gray200);color:var(--black);margin-bottom:.2rem;">
          Device {{ d.device_number }} â€“ ID {{ d.id }}
        </a>
        <div class="meta" style="color:var(--gray700);font-size:.95rem;">
          {% if d.online %}ðŸŸ¢ online{% else %}âšª offline{% endif %}
          {% if d.last_seen %} â€¢ last seen {{ d.last_seen }}{% endif %}
        </div>
      </li>
    {% endfor %}
  </ul>
{% endif %}
</div>
{% endblock %}
{% block scripts %}
<script>
async function refreshDeviceList() {
  try {
    const response = await fetch('/api/devices');
    if (!response.ok) return;
    
    const devices = await response.json();
    const deviceListEl = document.getElementById('device-list');
    const lastUpdatedEl = document.getElementById('last-updated');
    
    // Update timestamp
    lastUpdatedEl.textContent = new Date().toLocaleString();
    
    if (devices.length === 0) {
      deviceListEl.innerHTML = '<p>No devices found.</p>';
    } else {
      const listHtml = devices.map(d => `
        <li style="margin-bottom:.7rem;">
          <a href="/device/${encodeURIComponent(d.id)}" class="btn" style="background:var(--gray200);color:var(--black);margin-bottom:.2rem;">
            Device ${d.device_number || 'N/A'} â€“ ID ${d.id}
          </a>
          <div class="meta" style="color:var(--gray700);font-size:.95rem;">
            ${d.online ? 'ðŸŸ¢ online' : 'âšª offline'}
            ${d.last_seen ? ` â€¢ last seen ${d.last_seen}` : ''}
          </div>
        </li>
      `).join('');
      deviceListEl.innerHTML = `<ul>${listHtml}</ul>`;
    }
  } catch (error) {
    console.error('Failed to refresh device list:', error);
  }
}

// Set initial timestamp
document.getElementById('last-updated').textContent = new Date().toLocaleString();

// Refresh every 30 seconds
setInterval(refreshDeviceList, 30000);

// Also refresh when page becomes visible (if user switched tabs)
document.addEventListener('visibilitychange', () => {
  if (!document.hidden) {
    refreshDeviceList();
  }
});
</script>
{% endblock %}