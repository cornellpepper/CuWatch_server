{% extends "base.html" %}
{% block title %}Select Device â€“ CuWatch{% endblock %}
{% block style %}
<style>
  .device-select-layout { display: flex; gap: 2rem; align-items: flex-start; flex-wrap: wrap; }
  .device-select-main { flex: 1 1 320px; min-width: 280px; }
  .device-select-hero { flex: 0 0 260px; display: flex; justify-content: center; align-items: center; }
  .device-select-hero img { width: 100%; max-width: 320px; height: auto; display: block; }
ul { padding-left: 1.25rem; }
.meta { color: #444; font-size: .9rem; }
a.btn { display: inline-block; margin-top: .5rem; background: #eee; padding: .3rem .6rem; border-radius: 6px; text-decoration: none; }
</style>
{% endblock %}
{% block content %}
<div class="device-select-layout">
  <div class="device-select-main">
    <h1>Select a Device</h1>
    <div class="small" style="color: #666; margin-bottom: 1rem;">
      Last updated: <span id="last-updated">{{ moment().format('YYYY-MM-DD HH:mm:ss') if moment else 'loading...' }}</span>
      <span style="margin-left: 1rem;">
        <a href="{{ url_for('system_health') }}" style="color: #666; text-decoration: underline;">System Health</a>
      </span>
    </div>
    <div id="device-list">
    {% if devices|length == 0 %}
      <p>No devices found.</p>
    {% else %}
      <ul>
        {% for d in devices %}
          <li style="margin-bottom:.7rem;">
            <a href="{{ url_for('device_detail', device_id=d.id) }}" class="btn" style="background:var(--gray200);color:var(--black);margin-bottom:.2rem;">
              Device {{ d.device_number }} â€“ ID {{ d.id }}
            </a>
            <div class="meta" style="color:var(--gray700);font-size:.95rem;">
              {% if d.online %}ðŸŸ¢ online{% else %}âšª offline{% endif %}
              {% if d.last_seen %}<span class="js-last-seen" data-iso="{{ d.last_seen }}"> â€¢ last seen {{ d.last_seen }}</span>{% endif %}
            </div>
          </li>
        {% endfor %}
      </ul>
    {% endif %}
    </div>
  </div>
  <div class="device-select-hero" aria-hidden="true">
    <img src="{{ url_for('static', filename='logo_red_on_white.png') }}" alt="CuWatch logo in red on white" />
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
// Localize any server-rendered last-seen timestamps on initial paint
function localizeInitialTimes() {
  const nodes = document.querySelectorAll('.js-last-seen[data-iso]');
  nodes.forEach(node => {
    const iso = node.getAttribute('data-iso');
    if (!iso) return;
    const d = new Date(iso);
    if (!isNaN(d)) {
      node.textContent = ` â€¢ last seen ${d.toLocaleString()}`;
    }
  });
}

async function refreshDeviceList() {
  try {
    const response = await fetch('/api/devices');
    if (!response.ok) return;
    
    const devices = await response.json();
    const deviceListEl = document.getElementById('device-list');
    const lastUpdatedEl = document.getElementById('last-updated');
    
    // Update timestamp
    lastUpdatedEl.textContent = new Date().toLocaleString();
    
    if (devices.length === 0) {
      deviceListEl.innerHTML = '<p>No devices found.</p>';
    } else {
      const listHtml = devices.map(d => {
        let lastSeenText = '';
        if (d.last_seen) {
          const lastSeenDate = new Date(d.last_seen);
          lastSeenText = ` â€¢ last seen ${lastSeenDate.toLocaleString()}`;
        }
        return `
        <li style="margin-bottom:.7rem;">
          <a href="/device/${encodeURIComponent(d.id)}" class="btn" style="background:var(--gray200);color:var(--black);margin-bottom:.2rem;">
            Device ${d.device_number || 'N/A'} â€“ ID ${d.id}
          </a>
          <div class="meta" style="color:var(--gray700);font-size:.95rem;">
            ${d.online ? 'ðŸŸ¢ online' : 'âšª offline'}
            ${lastSeenText}
          </div>
        </li>
      `;
      }).join('');
      deviceListEl.innerHTML = `<ul>${listHtml}</ul>`;
    }
  } catch (error) {
    console.error('Failed to refresh device list:', error);
  }
}

// Set initial timestamp
document.getElementById('last-updated').textContent = new Date().toLocaleString();

// Localize server-rendered timestamps immediately
localizeInitialTimes();

// Kick off an immediate refresh to replace list with fresh data
refreshDeviceList();

// Refresh every 30 seconds
setInterval(refreshDeviceList, 30000);

// Also refresh when page becomes visible (if user switched tabs)
document.addEventListener('visibilitychange', () => {
  if (!document.hidden) {
    refreshDeviceList();
  }
});
</script>
{% endblock %}