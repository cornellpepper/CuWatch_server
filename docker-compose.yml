services:
  mqtt-broker:
    image: eclipse-mosquitto:2
    ports: ["1883:1883"]
    volumes:
      - ./deploy/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro

  db:
    image: postgres:16
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: iot
    ports:
      - "127.0.0.1:5432:5432"  # Only bind to localhost
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d iot"]
      interval: 3s
      timeout: 3s
      retries: 20

  web:
    build: ./services/web
    develop:
      watch:
        # Restart web on code changes; ignore templates to avoid unnecessary restarts
        - action: sync+restart
          path: ./services/web
          target: /app
          ignore:
            - templates/**
            - __pycache__/**
            - .venv/**
        # Sync templates without restart (Jinja auto-renders updated files)
        - action: sync
          path: ./services/web/templates
          target: /app/templates
    environment:
      DATABASE_URL: postgresql://postgres:postgres@db/iot
      MQTT_BROKER_URL: mqtt-broker
      MQTT_BROKER_PORT: 1883
      SECRET_KEY: "dev"
    depends_on:
      db:
        condition: service_healthy
      mqtt-broker:
        condition: service_started
    ports: ["80:80"]
    volumes:
      - /var/log/sysstat:/var/log/sysstat:ro
    command: >
      gunicorn
      -k eventlet
      -w 1
      -b 0.0.0.0:80
      app:app
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost/healthz || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 5

  bridge:
    build: ./services/bridge
    develop:
      watch:
        - action: rebuild
          path: ./services/bridge
          ignore:
            - __pycache__/**
            - .venv/**
    environment:
      DATABASE_URL: postgresql://postgres:postgres@db/iot
      MQTT_BROKER_URL: mqtt-broker
      MQTT_BROKER_PORT: 1883
    depends_on:
      db:
        condition: service_healthy
      mqtt-broker:
        condition: service_started
